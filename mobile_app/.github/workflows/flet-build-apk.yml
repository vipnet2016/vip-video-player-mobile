name: Build Flet APK for VIP Video Player

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Flet
      run: |
        pip install flet
        
    - name: Check Flet Installation
      run: |
        python -c "import flet; print(f'Flet version: {flet.__version__}')"
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'
        
    - name: Install Android SDK and setup environment
      run: |
        # Install Android command line tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip
        unzip commandlinetools-linux-7583922_latest.zip
        mkdir -p ~/android-sdk/cmdline-tools/latest
        mv cmdline-tools/* ~/android-sdk/cmdline-tools/latest/ 2>/dev/null || true
        export ANDROID_HOME=~/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        
        # Accept licenses
        yes | sdkmanager --licenses || true
        
        # Install required packages
        sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3"
        
        # Set environment variables
        echo "ANDROID_HOME=~/android-sdk" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        
    - name: Install Flet CLI
      run: |
        pip install flet-cli
        
    - name: Prepare app files
      run: |
        pwd
        ls -la
        mkdir -p app_build
        cp flet_app.py app_build/main.py  # Rename to main.py as expected by flet
        cp -r .??* app_build/ 2>/dev/null || true  # copy hidden files like .env, .gitignore, etc.
        
    - name: Check app files
      run: |
        cd app_build
        ls -la
        
    - name: Build Flet app - Main build
      run: |
        cd app_build
        flutter config --enable-android
        flet build apk .
        
    - name: Show build directory structure
      run: |
        pwd
        find . -type f -name "*.apk" -print
        find . -path "*/build/*" -name "*" -type f | head -20
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: flet-apk
        path: app_build/build/app/outputs/flutter-apk/*release.apk
      if: success()
      
    - name: Upload APK (alternative path)
      uses: actions/upload-artifact@v4
      with:
        name: flet-apk-debug
        path: app_build/build/app/outputs/flutter-apk/*debug.apk
      if: success()